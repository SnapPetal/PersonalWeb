<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Endurance Trivia</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}"/>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap-icons/font/bootstrap-icons.css}"/>
    <script th:src="@{/webjars/bootstrap/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/webjars/sockjs-client/sockjs.min.js}"></script>
    <script th:src="@{/webjars/stomp-websocket/stomp.min.js}"></script>
</head>
<body>
<div class="container mt-4">
    <h1>Endurance Trivia</h1>

    <div class="card mb-4">
        <div class="card-header">
            Connection Status
        </div>
        <div class="card-body">
            <p>Status: <span id="connection-status" class="badge bg-secondary">Disconnected</span></p>
            <button id="connect-btn" class="btn btn-primary">Connect</button>
            <button id="disconnect-btn" class="btn btn-danger d-none">Disconnect</button>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            Connection Log
        </div>
        <div class="card-body">
            <pre id="log" style="height: 200px; overflow-y: auto;"></pre>
        </div>
    </div>
</div>

<script>
    // WebSocket connection variables
    let stompClient = null;
    let isConnected = false;

    // DOM elements
    const connectBtn = document.getElementById('connect-btn');
    const disconnectBtn = document.getElementById('disconnect-btn');
    const connectionStatus = document.getElementById('connection-status');
    const logElement = document.getElementById('log');

    // Log function
    function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logLine = document.createElement('div');
        logLine.className = `text-${type}`;
        logLine.textContent = `[${timestamp}] ${message}`;
        logElement.appendChild(logLine);
        logElement.scrollTop = logElement.scrollHeight;
    }

    // Update UI based on connection state
    function updateConnectionUI(state, statusText, statusClass) {
        connectionStatus.textContent = statusText;
        connectionStatus.className = `badge ${statusClass}`;

        if (state === 'connected') {
            connectBtn.classList.add('d-none');
            disconnectBtn.classList.remove('d-none');
        } else {
            connectBtn.classList.remove('d-none');
            disconnectBtn.classList.add('d-none');
        }
    }

    // Connect to WebSocket
    function connect() {
        // Update UI
        updateConnectionUI('connecting', 'Connecting...', 'bg-warning');
        log('Attempting to connect to endurance.thonbecker.biz...');

        try {
            // Create WebSocket connection
            const socket = new WebSocket('wss://endurance.thonbecker.biz/quiz-websocket');

            // Initialize STOMP client
            stompClient = Stomp.over(socket);

            // Optional: Disable debug logs from STOMP
            stompClient.debug = null;

            // Connect with STOMP protocol
            stompClient.connect(
                {}, // Headers (empty in this case)
                function onConnect(frame) {
                    isConnected = true;
                    log('Connection established successfully!', 'success');
                    log('Connected with frame: ' + frame);
                    updateConnectionUI('connected', 'Connected', 'bg-success');

                    // Subscribe to topics
                    subscribeToTopics();
                },
                function onError(error) {
                    log('Connection error: ' + error, 'danger');
                    updateConnectionUI('disconnected', 'Failed', 'bg-danger');
                    isConnected = false;
                }
            );
        } catch (e) {
            log('Error creating connection: ' + e.message, 'danger');
            updateConnectionUI('disconnected', 'Error', 'bg-danger');
        }
    }

    // Subscribe to all required topics
    function subscribeToTopics() {
        // Subscribe to the public topic
        stompClient.subscribe('/topic/public', function(message) {
            handleIncomingMessage(message);
        });

        // Add more subscriptions as needed
        // stompClient.subscribe('/topic/another-topic', function(message) {...});
    }

    // Handle incoming messages
    function handleIncomingMessage(message) {
        try {
            log('Received message: ' + message.body);

            // If the message is JSON, you can parse it
            // const data = JSON.parse(message.body);
            // process the data...

        } catch (e) {
            log('Error processing message: ' + e.message, 'warning');
        }
    }

    // Send a message to the server
    function sendMessage(destination, body) {
        if (!isConnected || !stompClient) {
            log('Cannot send message: Not connected', 'warning');
            return false;
        }

        try {
            stompClient.publish({
                destination: destination,
                body: typeof body === 'string' ? body : JSON.stringify(body)
            });
            log(`Message sent to ${destination}`, 'info');
            return true;
        } catch (e) {
            log('Error sending message: ' + e.message, 'danger');
            return false;
        }
    }

    // Disconnect from WebSocket
    function disconnect() {
        if (stompClient) {
            if (isConnected) {
                stompClient.disconnect(function() {
                    log('Disconnected from server', 'warning');
                });
            }
            stompClient = null;
        }

        isConnected = false;
        updateConnectionUI('disconnected', 'Disconnected', 'bg-secondary');
    }

    // Set up event listeners
    connectBtn.addEventListener('click', connect);
    disconnectBtn.addEventListener('click', disconnect);

    // Example of how to send a message (can be called from anywhere)
    // sendMessage('/topic/public', 'Hello, everyone!');
    // sendMessage('/app/specific-endpoint', { data: 'structured data' });
</script>
</body>
</html>