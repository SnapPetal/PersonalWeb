<!DOCTYPE html>
<html lang="en-US" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title th:text="${tournament.name} + ' - Tournaments - Foosball'">Tournament Detail</title>

    <link rel="icon" href="/images/favicon.svg" type="image/svg+xml">

    <!-- CSRF Token -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <!-- CSS Dependencies -->
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/webjars/bootstrap-icons/font/bootstrap-icons.min.css}">
    <link href="/css/main.css" rel="stylesheet">
    <link href="/css/foosball.css" rel="stylesheet">

    <style>
        .bracket-container {
            overflow-x: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .bracket {
            display: flex;
            justify-content: space-around;
            min-width: fit-content;
        }

        .round {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            margin: 0 20px;
        }

        .round-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
            padding: 10px;
            background: #007bff;
            color: white;
            border-radius: 5px;
        }

        .match-container {
            margin: 20px 0;
            position: relative;
        }

        .match {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            min-width: 250px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .match-header {
            background: #e9ecef;
            padding: 8px 12px;
            border-bottom: 1px solid #dee2e6;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .team {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .team:last-child {
            border-bottom: none;
        }

        .team.winner {
            background: #d4edda;
            font-weight: bold;
        }

        .team.loser {
            opacity: 0.6;
        }

        .team-name {
            flex: 1;
        }

        .team-score {
            font-weight: bold;
            margin-left: 10px;
            font-size: 1.1rem;
        }

        .match.pending {
            border-color: #ffc107;
        }

        .match.ready {
            border-color: #28a745;
        }

        .match.completed {
            border-color: #6c757d;
        }

        .bye-match {
            font-style: italic;
            color: #6c757d;
        }

        .connector-line {
            position: absolute;
            border: 2px solid #dee2e6;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .registration-item {
            transition: background 0.2s;
        }

        .registration-item:hover {
            background: #f8f9fa;
        }
    </style>

    <!-- JS dependencies -->
    <script th:src="@{/webjars/htmx.org/dist/htmx.min.js}"></script>
    <script src="/js/csrf-utils.js"></script>
    <script th:src="@{/webjars/bootstrap/js/bootstrap.min.js}"></script>
</head>
<body class="foosball-page">
    <!-- Header -->
    <div class="foosball-header py-3 border-bottom bg-light">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0" th:text="${tournament.name}">Tournament Name</h4>
                    <small class="text-secondary" th:text="${tournament.description}"></small>
                </div>
                <div>
                    <a href="/foosball/tournaments" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left"></i> Back
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="py-4">
        <div class="container-fluid">
            <!-- Tournament Info Bar -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Status:</strong>
                                    <span class="ms-2 badge" th:classappend="${tournament.status == 'DRAFT' ? 'bg-secondary' : tournament.status == 'REGISTRATION_OPEN' ? 'bg-success' : tournament.status == 'IN_PROGRESS' ? 'bg-primary' : tournament.status == 'COMPLETED' ? 'bg-dark' : 'bg-warning'}"
                                          th:text="${tournament.status}"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Type:</strong>
                                    <span class="ms-2" th:text="${tournament.tournamentType}"></span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Participants:</strong>
                                    <span class="ms-2" th:text="${registrations.size()}"></span>
                                    <span th:if="${tournament.maxParticipants != null}" th:text="'/ ' + ${tournament.maxParticipants}"></span>
                                </div>
                                <div class="col-md-3">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button th:if="${tournament.status.name() == 'DRAFT'}"
                                                class="btn btn-outline-success"
                                                onclick="updateTournamentStatus('REGISTRATION_OPEN')">
                                            <i class="bi bi-door-open"></i> Open Registration
                                        </button>
                                        <button th:if="${tournament.status.name() == 'REGISTRATION_OPEN'}"
                                                class="btn btn-outline-warning"
                                                onclick="updateTournamentStatus('REGISTRATION_CLOSED')">
                                            <i class="bi bi-door-closed"></i> Close Registration
                                        </button>
                                        <button th:if="${tournament.status.name() == 'REGISTRATION_CLOSED'}"
                                                class="btn btn-outline-primary"
                                                onclick="startTournament()">
                                            <i class="bi bi-play-circle"></i> Start Tournament
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Bracket Visualization -->
                <div class="col-lg-9 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Tournament Bracket</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="bracket-container" id="bracket-container">
                                <div th:if="${tournament.status.name() == 'DRAFT' || tournament.status.name() == 'REGISTRATION_OPEN' || tournament.status.name() == 'REGISTRATION_CLOSED'}"
                                     class="text-center py-5 text-white">
                                    <i class="bi bi-hourglass-split" style="font-size: 3rem;"></i>
                                    <p class="mt-3">Bracket will be generated when the tournament starts</p>
                                </div>
                                <div th:if="${tournament.status.name() != 'DRAFT' && tournament.status.name() != 'REGISTRATION_OPEN' && tournament.status.name() != 'REGISTRATION_CLOSED'}"
                                     id="bracket"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-3">
                    <!-- Registrations -->
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-people"></i> Participants</h6>
                            <button th:if="${tournament.status.name() == 'REGISTRATION_OPEN'}"
                                    class="btn btn-sm btn-primary"
                                    data-bs-toggle="modal"
                                    data-bs-target="#registerModal">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div th:if="${registrations.isEmpty()}" class="p-3 text-center text-white">
                                No participants yet
                            </div>
                            <div th:each="reg : ${registrations}" class="registration-item p-3 border-bottom">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong th:text="${reg.getDisplayName()}"></strong>
                                        <span th:if="${reg.seed != null}" class="badge bg-secondary ms-1" th:text="'#' + ${reg.seed}"></span>
                                    </div>
                                    <span class="badge"
                                          th:classappend="${reg.status == 'ACTIVE' ? 'bg-success' : reg.status == 'WITHDRAWN' ? 'bg-warning' : 'bg-danger'}"
                                          th:text="${reg.status}"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ready Matches for Score Entry -->
                    <div th:if="${tournament.status.name() == 'IN_PROGRESS'}" class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-clipboard-check"></i> Enter Scores</h6>
                        </div>
                        <div class="card-body p-0" id="ready-matches-container">
                            <div class="p-3 text-center text-muted">Loading matches...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Register Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Register for Tournament</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="regPlayer1" class="form-label">Player <span class="text-danger">*</span></label>
                            <select class="form-select" id="regPlayer1" name="playerId" required>
                                <option value="">Select Player</option>
                                <option th:each="player : ${players}" th:value="${player.id}" th:text="${player.name}"></option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="regPlayer2" class="form-label">Partner (Optional for 1v1)</label>
                            <select class="form-select" id="regPlayer2" name="partnerId">
                                <option value="">None (Singles)</option>
                                <option th:each="player : ${players}" th:value="${player.id}" th:text="${player.name}"></option>
                            </select>
                        </div>

                        <div class="alert alert-info py-2" th:if="${players.isEmpty()}">
                            <small>
                                <i class="bi bi-info-circle"></i> No players found.
                                <a href="/foosball" target="_blank" class="alert-link">Create players first</a>
                                then refresh this page.
                            </small>
                        </div>

                        <div class="mb-3">
                            <label for="teamName" class="form-label">Team Name (Optional)</label>
                            <input type="text" class="form-control" id="teamName" name="teamName">
                        </div>
                        <div class="mb-3">
                            <label for="seed" class="form-label">Seed (Optional)</label>
                            <input type="number" class="form-control" id="seed" name="seed" min="1">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="registerForTournament()">Register</button>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const tournamentId = /*[[${tournament.id}]]*/ 0;
        const tournamentStatus = /*[[${tournament.status}]]*/ '';

        // Render bracket if tournament is in progress
        if (tournamentStatus !== 'DRAFT' && tournamentStatus !== 'REGISTRATION_OPEN' && tournamentStatus !== 'REGISTRATION_CLOSED') {
            loadAndRenderBracket();
            loadReadyMatches();
        }

        async function loadAndRenderBracket() {
            try {
                const response = await fetch(`/api/tournaments/${tournamentId}/bracket`);
                if (response.ok) {
                    const bracket = await response.json();
                    console.log('Loaded bracket:', bracket);
                    console.log('Number of matches:', bracket.length);
                    if (bracket.length === 0) {
                        console.warn('Bracket is empty! Tournament may not have started properly.');
                        document.getElementById('bracket').innerHTML = '<p class="text-center text-warning py-5">No matches found. Please check server logs.</p>';
                    } else {
                        renderBracket(bracket);
                    }
                } else {
                    console.error('Failed to load bracket, status:', response.status);
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                }
            } catch (error) {
                console.error('Error loading bracket:', error);
            }
        }

        function renderBracket(matches) {
            if (!matches || matches.length === 0) {
                document.getElementById('bracket').innerHTML = '<p class="text-center text-muted py-5">No matches yet</p>';
                return;
            }

            // Check if this is a double elimination tournament
            const hasLosersBracket = matches.some(m => m.bracketType === 'LOSERS');

            if (hasLosersBracket) {
                renderDoubleEliminationBracket(matches);
            } else {
                renderSingleEliminationBracket(matches);
            }
        }

        function renderSingleEliminationBracket(matches) {
            // Group matches by round
            const rounds = {};
            matches.forEach(match => {
                if (!rounds[match.roundNumber]) {
                    rounds[match.roundNumber] = [];
                }
                rounds[match.roundNumber].push(match);
            });

            const roundNumbers = Object.keys(rounds).sort((a, b) => a - b);
            const maxRound = Math.max(...roundNumbers);

            let html = '<div class="bracket">';

            roundNumbers.forEach(roundNum => {
                const roundMatches = rounds[roundNum];
                const roundName = getRoundName(parseInt(roundNum), maxRound);

                html += `<div class="round">`;
                html += `<div class="round-title">${roundName}</div>`;

                roundMatches.forEach(match => {
                    html += renderMatch(match);
                });

                html += `</div>`;
            });

            html += '</div>';
            document.getElementById('bracket').innerHTML = html;
        }

        function renderDoubleEliminationBracket(matches) {
            const mainBracket = matches.filter(m => m.bracketType === 'MAIN');
            const losersBracket = matches.filter(m => m.bracketType === 'LOSERS');

            let html = '<div style="margin-bottom: 40px;">';

            // Winner's Bracket
            html += '<h5 class="text-center mb-3" style="color: #28a745;"><i class="bi bi-trophy-fill"></i> Winner\'s Bracket</h5>';
            html += renderBracketSection(mainBracket, 'winners');

            html += '</div>';

            // Loser's Bracket
            if (losersBracket.length > 0) {
                html += '<div style="margin-top: 40px; padding-top: 40px; border-top: 3px solid #dee2e6;">';
                html += '<h5 class="text-center mb-3" style="color: #ffc107;"><i class="bi bi-arrow-counterclockwise"></i> Loser\'s Bracket</h5>';
                html += renderBracketSection(losersBracket, 'losers');
                html += '</div>';
            }

            document.getElementById('bracket').innerHTML = html;
        }

        function renderBracketSection(matches, bracketName) {
            if (!matches || matches.length === 0) return '';

            // Group matches by round
            const rounds = {};
            matches.forEach(match => {
                if (!rounds[match.roundNumber]) {
                    rounds[match.roundNumber] = [];
                }
                rounds[match.roundNumber].push(match);
            });

            const roundNumbers = Object.keys(rounds).sort((a, b) => a - b);
            const maxRound = Math.max(...roundNumbers);

            let html = '<div class="bracket">';

            roundNumbers.forEach(roundNum => {
                const roundMatches = rounds[roundNum];
                const roundName = bracketName === 'winners'
                    ? getRoundName(parseInt(roundNum), maxRound)
                    : `LB Round ${roundNum}`;

                html += `<div class="round">`;
                html += `<div class="round-title">${roundName}</div>`;

                roundMatches.forEach(match => {
                    html += renderMatch(match);
                });

                html += `</div>`;
            });

            html += '</div>';
            return html;
        }

        function renderMatch(match) {
            const statusClass = match.status.toLowerCase();
            let html = `<div class="match-container">`;
            html += `<div class="match ${statusClass}">`;
            html += `<div class="match-header">Match ${match.matchNumber}</div>`;

            // Team 1
            const team1Winner = match.winnerDisplayName && match.team1DisplayName === match.winnerDisplayName;
            const team1Class = match.status === 'COMPLETED' ? (team1Winner ? 'winner' : 'loser') : '';
            html += `<div class="team ${team1Class}">`;
            html += `<span class="team-name">${match.team1DisplayName || 'TBD'}</span>`;
            if (match.status === 'COMPLETED' && team1Winner) {
                html += `<i class="bi bi-trophy-fill text-warning"></i>`;
            }
            html += `</div>`;

            // Team 2
            const team2Winner = match.winnerDisplayName && match.team2DisplayName === match.winnerDisplayName;
            const team2Class = match.status === 'COMPLETED' ? (team2Winner ? 'winner' : 'loser') : '';
            html += `<div class="team ${team2Class}">`;
            html += `<span class="team-name">${match.team2DisplayName || 'TBD'}</span>`;
            if (match.status === 'COMPLETED' && team2Winner) {
                html += `<i class="bi bi-trophy-fill text-warning"></i>`;
            }
            html += `</div>`;

            html += `</div>`;
            html += `</div>`;

            return html;
        }

        function getRoundName(roundNum, maxRound) {
            const diff = maxRound - roundNum;
            if (diff === 0) return 'Final';
            if (diff === 1) return 'Semi-Finals';
            if (diff === 2) return 'Quarter-Finals';
            return `Round ${roundNum}`;
        }

        async function registerForTournament() {
            const form = document.getElementById('registerForm');
            const formData = new FormData(form);

            const playerId = formData.get('playerId');
            const partnerId = formData.get('partnerId');

            if (!playerId) {
                alert('Player is required');
                return;
            }

            const request = {
                playerId: parseInt(playerId),
                partnerId: partnerId ? parseInt(partnerId) : null,
                teamName: formData.get('teamName') || null,
                seed: formData.get('seed') ? parseInt(formData.get('seed')) : null
            };

            try {
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                const response = await fetch(`/api/tournaments/${tournamentId}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify(request)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
                    form.reset();
                    window.location.reload();
                } else {
                    const error = await response.text();
                    alert('Failed to register: ' + error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to register');
            }
        }

        async function startTournament() {
            if (!confirm('Are you sure you want to start the tournament? This will generate the bracket and matches cannot be undone.')) {
                return;
            }

            try {
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                console.log('Starting tournament...');
                const response = await fetch(`/api/tournaments/${tournamentId}/start`, {
                    method: 'POST',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                });

                console.log('Start tournament response status:', response.status);
                if (response.ok) {
                    const result = await response.json();
                    console.log('Tournament started successfully:', result);
                    window.location.reload();
                } else {
                    const errorText = await response.text();
                    console.error('Failed to start tournament:', errorText);
                    alert('Failed to start tournament: ' + errorText);
                }
            } catch (error) {
                console.error('Error starting tournament:', error);
                alert('Failed to start tournament: ' + error.message);
            }
        }

        async function updateTournamentStatus(action) {
            try {
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                const endpoint = action === 'REGISTRATION_OPEN' ? 'registration/open' : 'registration/close';
                const response = await fetch(`/api/tournaments/${tournamentId}/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to update tournament status');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to update tournament status');
            }
        }

        async function loadReadyMatches() {
            try {
                const response = await fetch(`/api/tournaments/${tournamentId}/matches`);
                if (response.ok) {
                    const matches = await response.json();
                    const readyMatches = matches.filter(m => m.status === 'READY');
                    console.log('Ready matches:', readyMatches);
                    renderReadyMatches(readyMatches);
                }
            } catch (error) {
                console.error('Error loading ready matches:', error);
            }
        }

        function renderReadyMatches(matches) {
            const container = document.getElementById('ready-matches-container');

            if (matches.length === 0) {
                container.innerHTML = '<div class="p-3 text-center text-muted">No matches ready for scoring</div>';
                return;
            }

            let html = '';
            matches.forEach(match => {
                html += `
                    <div class="p-3 border-bottom">
                        <div class="mb-2">
                            <strong>Round ${match.roundNumber}, Match ${match.matchNumber}</strong>
                        </div>
                        <form id="score-form-${match.id}" onsubmit="submitScore(event, ${match.id})">
                            <div class="row g-2 align-items-end">
                                <div class="col-5">
                                    <label class="form-label small mb-1">${match.team1DisplayName || 'Team 1'}</label>
                                    <input type="number" class="form-control form-control-sm" min="0" max="10"
                                           id="team1-score-${match.id}" required>
                                </div>
                                <div class="col-2 text-center">
                                    <span class="fw-bold">vs</span>
                                </div>
                                <div class="col-5">
                                    <label class="form-label small mb-1">${match.team2DisplayName || 'Team 2'}</label>
                                    <input type="number" class="form-control form-control-sm" min="0" max="10"
                                           id="team2-score-${match.id}" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm mt-2 w-100">
                                <i class="bi bi-check-circle"></i> Record Score
                            </button>
                        </form>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function submitScore(event, matchId) {
            event.preventDefault();

            const team1Score = parseInt(document.getElementById(`team1-score-${matchId}`).value);
            const team2Score = parseInt(document.getElementById(`team2-score-${matchId}`).value);

            if (team1Score === team2Score) {
                alert('Scores cannot be tied! Please enter different scores.');
                return;
            }

            try {
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                const response = await fetch(`/api/tournaments/matches/${matchId}/score`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify({
                        team1Score: team1Score,
                        team2Score: team2Score
                    })
                });

                if (response.ok) {
                    console.log('Score recorded successfully');
                    // Reload the page to show updated bracket
                    window.location.reload();
                } else {
                    const errorText = await response.text();
                    alert('Failed to record score: ' + errorText);
                }
            } catch (error) {
                console.error('Error recording score:', error);
                alert('Failed to record score: ' + error.message);
            }
        }
    </script>
</body>
</html>
